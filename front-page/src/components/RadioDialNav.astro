---
import LanguageSwitcher from './LanguageSwitcher.astro';
import { getLangFromUrl } from '../i18n/config';
import { loadTranslationsWithCache, createTranslator } from '../i18n/utils';

const currentPath = Astro.url.pathname;
const currentLang = getLangFromUrl(Astro.url);

// Load translations
const translations = await loadTranslationsWithCache(currentLang);
const t = createTranslator(translations);

// Clean path for navigation (remove language prefix)
const cleanPath = currentLang !== 'en' && currentPath.startsWith(`/${currentLang}`) 
  ? currentPath.substring(currentLang.length + 1) || '/'
  : currentPath;

const stations = [
  { href: '/', label: t('nav.home', 'HOME'), frequency: t('nav.frequencies.home', '88.5 FM'), id: 'home' },
  { href: '/about', label: t('nav.about', 'ABOUT'), frequency: t('nav.frequencies.about', '92.3 FM'), id: 'about' },
  { href: '/technology', label: t('nav.technology', 'TECH'), frequency: t('nav.frequencies.technology', '96.7 FM'), id: 'tech' },
  { href: 'https://docs.for-the-gg.org', label: t('nav.docs', 'DOCS'), frequency: t('nav.frequencies.docs', '98.3 FM'), id: 'docs', external: true },
  { href: 'https://datasette.for-the-gg.org', label: t('nav.data', 'DATA'), frequency: t('nav.frequencies.data', '99.9 FM'), id: 'data', external: true },
  { href: 'https://github.com/For-The-Greater-Good', label: t('nav.github', 'GITHUB'), frequency: t('nav.frequencies.github', '101.1 FM'), id: 'github', external: true },
];

// Add language prefix to internal links if needed
const localizedStations = stations.map(station => ({
  ...station,
  href: station.external || currentLang === 'en' 
    ? station.href 
    : `/${currentLang}${station.href}`
}));
---

<nav class="radio-dial-nav">
  <div class="dial-container">
    <!-- Radio Brand -->
    <div class="radio-brand">
      <img 
        src="/images/ftgg-logo.png" 
        alt="FTGG Radio" 
        class="brand-logo"
      />
      <span class="brand-text">FTGG RADIO</span>
    </div>
    
    <!-- Frequency Display -->
    <div class="frequency-display">
      <span class="freq-label">FREQ</span>
      <span class="freq-value" id="current-freq">88.5</span>
      <span class="freq-unit">FM</span>
    </div>
    
    <!-- Radio Dial -->
    <div class="radio-dial">
      <div class="dial-track">
        <div class="dial-markings"></div>
        <div class="dial-needle" id="dial-needle"></div>
      </div>
      
      <!-- Station Buttons -->
      <div class="station-buttons">
        {localizedStations.map((station) => (
          <a 
            href={station.href}
            target={station.external ? '_blank' : undefined}
            rel={station.external ? 'noopener noreferrer' : undefined}
            class={`station-btn ${cleanPath === station.href || currentPath === station.href ? 'active' : ''}`}
            data-frequency={station.frequency}
            data-station={station.id}
          >
            <span class="station-label">{station.label}</span>
            <span class="station-freq">{station.frequency}</span>
          </a>
        ))}
      </div>
    </div>
    
    <!-- Volume/Power Controls -->
    <div class="radio-controls">
      <button class="control-btn power-btn" aria-label="Power">
        <span class="power-light"></span>
      </button>
      <div class="volume-knob">
        <span class="knob-label">VOL</span>
        <div class="knob"></div>
      </div>
      <LanguageSwitcher />
    </div>
</nav>

<style>
  .radio-dial-nav {
    position: fixed;
    top: 0;
    width: 100%;
    background: linear-gradient(180deg, var(--ink-black) 0%, var(--ink-soft) 100%);
    border-bottom: var(--border-thick);
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  .dial-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-md) var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-lg);
  }
  
  /* Radio Brand */
  .radio-brand {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  
  .brand-logo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid var(--mustard-gold);
    filter: drop-shadow(0 0 4px var(--mustard-gold));
  }
  
  .brand-text {
    font-size: var(--font-scale-lg);
    font-weight: 900;
    color: var(--mustard-gold);
    text-shadow: 0 0 8px rgba(253, 203, 110, 0.5);
    letter-spacing: -0.02em;
  }
  
  /* Frequency Display */
  .frequency-display {
    background: var(--ink-black);
    border: 2px solid var(--mustard-gold);
    padding: var(--space-xs) var(--space-sm);
    border-radius: 4px;
    display: flex;
    align-items: baseline;
    gap: var(--space-xs);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
  }
  
  .freq-label {
    font-size: var(--font-scale-xs);
    color: var(--rust-orange);
    font-weight: 900;
  }
  
  .freq-value {
    font-size: var(--font-scale-lg);
    color: var(--mustard-gold);
    font-weight: 900;
    text-shadow: 0 0 4px var(--mustard-gold);
    font-family: 'Courier New', monospace;
  }
  
  .freq-unit {
    font-size: var(--font-scale-sm);
    color: var(--ocean-teal);
    font-weight: 900;
  }
  
  /* Radio Dial */
  .radio-dial {
    flex: 1;
    position: relative;
  }
  
  .dial-track {
    height: 60px;
    background: linear-gradient(90deg, 
      var(--ink-soft) 0%, 
      var(--ink-black) 50%, 
      var(--ink-soft) 100%
    );
    border-top: 2px solid var(--mustard-gold);
    border-bottom: 2px solid var(--mustard-gold);
    position: relative;
    overflow: hidden;
  }
  
  .dial-markings {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: repeating-linear-gradient(
      90deg,
      transparent 0px,
      transparent 9px,
      var(--mustard-gold) 9px,
      var(--mustard-gold) 10px
    );
    opacity: 0.3;
  }
  
  .dial-needle {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--rust-orange);
    left: 10%;
    box-shadow: 0 0 8px var(--rust-orange);
    transition: left 0.3s ease;
    z-index: 2;
  }
  
  /* Station Buttons */
  .station-buttons {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    transform: translateY(-50%);
    display: flex;
    justify-content: space-around;
    padding: 0 var(--space-lg);
    z-index: 3;
  }
  
  .station-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: var(--vintage-cream);
    transition: all 0.3s ease;
    position: relative;
    padding: var(--space-xs);
  }
  
  .station-label {
    font-size: var(--font-scale-base);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -0.02em;
    text-shadow: 2px 2px 0 var(--ink-black);
  }
  
  .station-freq {
    font-size: var(--font-scale-xs);
    color: var(--mustard-gold);
    opacity: 0;
    transition: opacity 0.3s ease;
    margin-top: 2px;
  }
  
  .station-btn:hover .station-freq {
    opacity: 1;
  }
  
  .station-btn:hover .station-label {
    color: var(--mustard-gold);
    text-shadow: 0 0 8px var(--mustard-gold);
  }
  
  .station-btn.active .station-label {
    color: var(--rust-orange);
    text-shadow: 0 0 8px var(--rust-orange);
  }
  
  .station-btn.active .station-freq {
    opacity: 1;
    color: var(--rust-orange);
  }
  
  /* Radio Controls */
  .radio-controls {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }
  
  .control-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid var(--rust-orange);
    background: var(--ink-black);
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
  }
  
  .power-light {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--rust-orange);
    box-shadow: 0 0 10px var(--rust-orange);
  }
  
  .control-btn:hover {
    transform: scale(1.1);
  }
  
  .volume-knob {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
  }
  
  .knob-label {
    font-size: var(--font-scale-xs);
    color: var(--ocean-teal);
    font-weight: 900;
  }
  
  .knob {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--ink-soft) 0%, var(--ink-black) 100%);
    border: 2px solid var(--ocean-teal);
    position: relative;
    cursor: pointer;
  }
  
  .knob::after {
    content: '';
    position: absolute;
    top: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 8px;
    background: var(--ocean-teal);
  }
  
  /* Mobile Responsive */
  @media (max-width: 768px) {
    .dial-container {
      flex-direction: column;
      gap: var(--space-sm);
      padding: var(--space-sm);
    }
    
    .radio-dial {
      width: 100%;
    }
    
    .station-buttons {
      position: static;
      transform: none;
      margin-top: var(--space-sm);
    }
    
    .dial-track {
      height: 40px;
    }
    
    .radio-controls {
      display: none;
    }
    
    .frequency-display {
      display: none;
    }
  }
</style>

<script>
  // Add interactive dial behavior
  const stationBtns = document.querySelectorAll('.station-btn');
  const dialNeedle = document.getElementById('dial-needle');
  const freqDisplay = document.getElementById('current-freq');
  
  stationBtns.forEach((btn, index) => {
    btn.addEventListener('mouseenter', () => {
      const freq = btn.getAttribute('data-frequency');
      const position = 10 + (index * 15); // Distribute across dial (6 stations)
      
      if (dialNeedle) {
        dialNeedle.style.left = `${position}%`;
      }
      
      if (freqDisplay && freq) {
        freqDisplay.textContent = freq.replace(' FM', '');
      }
    });
  });
  
  // Set initial position for active station
  const activeBtn = document.querySelector('.station-btn.active');
  if (activeBtn) {
    const activeBtns = Array.from(stationBtns);
    const activeIndex = activeBtns.indexOf(activeBtn);
    const position = 10 + (activeIndex * 15); // 6 stations
    
    if (dialNeedle) {
      dialNeedle.style.left = `${position}%`;
    }
    
    const freq = activeBtn.getAttribute('data-frequency');
    if (freqDisplay && freq) {
      freqDisplay.textContent = freq.replace(' FM', '');
    }
  }
</script>